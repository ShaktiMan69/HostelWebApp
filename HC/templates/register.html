{% extends 'base.html' %}
{% block content %}
<link href="assets/css/register.css" rel="stylesheet">
<div class="rcontainer">
  <div class="slider tw-rounded-full tw-overflow-hidden">
    <div
      class="progress tw-bg-gradient-to-r tw-from-blue-500 tw-via-indigo-600 tw-to-indigo-700 tw-rounded-full tw-transition-all tw-duration-1000 tw-ease-in-out"
    ></div>
  </div>
  <form id="registrationForm" method="post" enctype="multipart/form-data">
    {{ form.hidden_tag() }}
    <div class="page active" id="page0" pageNo="0">
      <h2 class="tw-text-2xl tw-font-semibold tw-text-center">
        Personal Information
      </h2>
      <div class="input-group">
        {{ form.name.label }} {{ form.name(class_="form-control") }}
      </div>
      <br />
      <div class="input-group">
        {{ form.address.label }} {{ form.address(class_="form-control") }}
      </div>
      <br />
      <br />
      <div class="input-group">
        {{ form.distance.label }} {{ form.distance(class_="form-control", min_='0', oninput_="this.value = Math.abs(this.value)") }}
      </div>
      <br />
      <br />
      <div class="input-group">
        {{ form.phone.label }} {{ form.phone(class_="form-control", min_='0', maxlength_="10", oninput_="this.value = Math.abs(this.value)", pattern_="[1-9]{1}[0-9]{9}") }}
      </div>
      <br />
      <br />
      <div class="input-group">
        {{ form.email.label }} {{ form.email(class_="form-control") }}
      </div>
      <br />
      <br />
      <div class="input-group">
        {{ form.password.label }} {{ form.password(class_="form-control") }}
      </div>
      <br />
      <br />
      <div class="input-group">
        {{ form.parent_name.label }} {{ form.parent_name(class_="form-control") }}
      </div>
      <br />
      <br />
      <div class="input-group">
        {{ form.parent_phone.label }} {{ form.parent_phone(class_="form-control", min_='0', maxlength_="10", oninput_="this.value = Math.abs(this.value)", pattern_="[1-9]{1}[0-9]{9}") }}
      </div>
      <br />
      <button
        type="button"
        class="button tw-bg-gradient-to-r tw-from-blue-500 tw-via-blue-600 tw-to-blue-700 hover:tw-bg-gradient-to-br"
        onclick="nextPage()"
      >
        Next
      </button>
    </div>
    <div class="page" id="page1" pageNo="1">
      <h2 class="tw-text-2xl tw-font-semibold tw-text-center">
        College Information
      </h2>
      <div class="input-group">
        {{ form.year.label }} {{ form.year(class_="form-control", style_="width:auto") }}
      </div>
      <br />
      <div class="input-group">
        {{ form.semester.label }} {{ form.semester(class_="form-control", style_="width:auto") }}
      </div>
      <br />
      <div class="input-group">
        {{ form.pr_number.label }} {{ form.pr_number(class_="form-control") }}
      </div>
      <br />
      <div class="input-group">
        {{ form.department.label }} {{ form.department(class_="form-control", style_="width:auto") }}
      </div>
      <br />
      <div class="input-group">
        {{ form.photo.label }} {{ form.photo(class_="form-control", accept_="image/png, image/jpeg") }}
      </div>
      <br />
      <br />
      <div class="input-group">
        {{ form.id_proof.label }} {{ form.id_proof(class_="form-control", accept_=" application/pdf") }}
      </div>
      <div class="input-group">
        {{ form.hostel_num(type_="hidden") }}
      </div>
      <div class="input-group">
        {{ form.room_num(type_="hidden") }}
      </div>
      <input type="hidden" id="gender">
      <input type="hidden" id="floor_num">

      <button type="button" onclick="prevPage()" class="button tw-bg-gradient-to-r tw-from-blue-500 tw-via-blue-600 tw-to-blue-700 hover:tw-bg-gradient-to-br">Previous</button>
      <button type="button" onclick="nextPage()" class="button tw-bg-gradient-to-r tw-from-blue-500 tw-via-blue-600 tw-to-blue-700 hover:tw-bg-gradient-to-br">Next</button>
    </div>
    <!-- Additional pages if needed -->
    <!-- Submit page -->
    <div class="page" id="page2" pageNo="2">
      <!-- Modal -->
      <div class="modal fade" id="M" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog  modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h1 class="modal-title fs-5" id="exampleModalLabel">Room Photos</h1>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div id="carouselExampleControls" class="carousel slide" data-ride="carousel">
                <div class="carousel-inner">
                  <div class="carousel-item active">
                    <img class="d-block w-100" src="" alt="First slide">
                  </div>
                  <div class="carousel-item">
                    <img class="d-block w-100" src="" alt="Second slide">
                  </div>
                  <div class="carousel-item">
                    <img class="d-block w-100" src="" alt="Third slide">
                  </div>
                  <div class="carousel-item">
                    <img class="d-block w-100" src="" alt="Fourth slide">
                  </div>
                  <div class="carousel-item">
                    <img class="d-block w-100" src="" alt="Fifth slide">
                  </div>
                </div>
                <a class="carousel-control-prev" href="#carouselExampleControls" role="button" data-slide="prev">
                  <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                  <span class="sr-only">Previous</span>
                </a>
                <a class="carousel-control-next" href="#carouselExampleControls" role="button" data-slide="next">
                  <span class="carousel-control-next-icon" aria-hidden="true"></span>
                  <span class="sr-only">Next</span>
                </a>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" onclick="prevPage()" class="button tw-bg-gradient-to-r tw-from-blue-500 tw-via-blue-600 tw-to-blue-700 hover:tw-bg-gradient-to-br">Previous</button>
              <button type="button" onclick="nextPage()" class="button tw-bg-gradient-to-r tw-from-blue-500 tw-via-blue-600 tw-to-blue-700 hover:tw-bg-gradient-to-br">Next</button>
            </div>
          </div>
        </div>
      </div>

      <style>
        .modal-open, body {overflow: inherit !important;}

        .modal-dialog {
        max-width: max-content !important;
        }

        .modal-body {
          display: flex;
        }

        .modal-body img {
          object-fit: contain;
        }


      </style>
      <script>
        $(function(){
          var current = location.pathname;
          var ulChildren = document.getElementsByClassName('nav')[0].children;                
          var childrenLength = ulChildren.length;

          for (var i = 0; i < childrenLength; i++) {
            if (ulChildren[i].children[0].getAttribute('href') === current) {
              ulChildren[i].classList.add('active');
            }
          }
      })

      </script>
      <style>
        * {
          font-family: "Inter", sans-serif;
          font-optical-sizing: auto;
          font-style: normal;
          font-variation-settings: "slnt" 0;
        }

        .room-btn {
          width: 50px !important;
          border-radius: 10px;
          outline: none;
          border: 0;
          padding: 2em 4em;
          display: inline-flex;
          justify-content: center;
        }

        .gender-card:hover {
          cursor: pointer;
        }

      </style>
      <div class="container">
        <div class="container tw-bg-blue-500 tw-rounded-lg px-5 py-3 text-light text-center my-3" style="max-width: 700px">
          <h3 class="my-3 tw-text-3xl tw-font-semibold">Rooms</h3>
          <div
          class="gender-select tw-gap-5 md:tw-gap-10 tw-flex tw-flex-col md:tw-flex-row md:tw-items-center"
        >
          <div
            id="boys"
            class="tw-transition-colors tw-duration-300 [&.active]:tw-bg-gradient-to-br tw-from-green-500 tw-via-green-600 tw-to-green-700 hover:tw-bg-green-200 [&.active]:tw-text-white gender-card card col p-5 tw-rounded-lg tw-font-semibold tw-text-xl"
            style="color: black;"
          >
            BOYS HOSTEL
          </div>
          <div
            id="girls"
            class="tw-transition-colors tw-duration-300 [&.active]:tw-bg-gradient-to-br tw-from-pink-500 tw-via-pink-600 tw-to-pink-700 hover:tw-bg-pink-200 [&.active]:tw-text-white gender-card card col p-5 tw-rounded-lg tw-font-semibold tw-text-xl"
            style="color: black;"
          >
            GIRLS HOSTEL
          </div>
        </div>
          <div id="drops" class="mt-4">

            <div id="id-boys" class="mb-2 form-floating" style="display: none">
              <select class="form-select" aria-label="Boys Hostel Room">
                <option value="1">ID1</option>
                <option value="2">ID2</option>
                <option value="3">ID3</option>
              </select>
              <label class="text-dark" for="floor">Select ID</label>
            </div>
            <div id="id-girls" class="mb-2 form-floating" style="display: none">
              <select class="form-select" aria-label="Girls Hostel Room">
                <option value="4">ID4</option>
                <option value="5">ID5</option>
              </select>
              <label class="text-dark" for="floor">Select ID</label>
            </div>
            <div id="floor" class="mb-2 form-floating"  style="display: none">
              <select class="form-select" aria-label="Select Floor">
                <option value="1">Ground Floor</option>
                <option value="2">First Floor</option>
              </select>
              <label class="text-dark" for="floor">Select Floor</label>
            </div>
            <div class="d-grid gap-2">
              <button class="btn btn-success" type="button" id="getDetails" style="display: none" >Get Details</button>
            </div>
          </div>
        </div>
        <div
        class="container tw-bg-gray-300 tw-rounded-lg p-2 text-light text-center"
        style="max-width: 700px"
      >
          <div class="container text-center">
            <div class="tw-grid tw-grid-cols-1 md:tw-grid-cols-3 tw-gap-5"  id="rooms_grid">
              <!-- <div>
                <button
                  type="button"
                  class="btn tw-bg-gradient-to-r tw-from-green-500 tw-via-green-600 tw-to-green-700 hover:tw-bg-gradient-to-br tw-text-white tw-font-medium disabled:tw-from-red-400 disabled:tw-via-red-500 disabled:tw-to-red-600 disabled:tw-cursor-not-allowed room-btn"
                  data-bs-toggle="modal" data-bs-target="#M1" onclick="setRoom(1)"
                >
                  1
                </button>
              </div> -->
            </div>
          </div>
        </div>
      </div>




      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
      <script>
        let girls = document.getElementById("girls");
        let boys = document.getElementById("boys");
        let idBoys = document.getElementById("id-boys");
        let idGirls = document.getElementById("id-girls");
        let floor = document.getElementById("floor");
        let getBtn = document.getElementById("getDetails");

        let borg = null;

        function listToMatrix(list, elementsPerSubArray) {
            var matrix = [], i, k;

            for (i = 0, k = -1; i < list.length; i++) {
                if (i % elementsPerSubArray === 0) {
                    k++;
                    matrix[k] = [];
                }

                matrix[k].push(list[i]);
            }

            return matrix;
        }

      function setRoom(gender, hostel_num, floor_num, room_num) {
        let room = document.getElementsByClassName("modal fade")[0];
        room.setAttribute('id', 'M'+String(room_num));
        let images = document.getElementsByClassName('d-block w-100')

        for (let i = 0; i < images.length; i++) {
          images[i].setAttribute('src', '/assets/img/rooms/'+String(gender)+'/'+String(hostel_num)+'/'+String(floor_num)+'/'+String(room_num)+'/'+String(i+1)+'.jpg')
        }

        $('#M'+String(room_num)).modal('show')
        
        if (gender == 'g'){
          gender = 'Girl';
        } else {
          gender = 'Boy';
        }
        
        if (floor_num == 1){
          floor_num = 'Ground Floor';
        } else {
          floor_num = 'First Floor';
        }

        document.getElementById('gender').value = gender;
        document.getElementById('room_num').value = room_num;
        document.getElementById('floor_num').value = floor_num;
        document.getElementById('hostel_num').value = 'ID'+hostel_num;
      }

        function range(n){
          return [...Array(n).keys()]
        }

      // Function to generate HTML buttons
      function generateButtons(occupancy_status, rooms_id) {
        const buttonsContainer = document.getElementById(rooms_id);
        
        // Clear any existing buttons
        buttonsContainer.innerHTML = '';

        // Generate buttons
        for (let i = 1; i <= occupancy_status.length; i++) {
          const buttonDiv = document.createElement('div');
          buttonDiv.setAttribute('class', 'col');
          
          const button = document.createElement('button');
          button.setAttribute('type', 'button');
          button.setAttribute('class', 'btn tw-bg-gradient-to-r tw-from-green-500 tw-via-green-600 tw-to-green-700 hover:tw-bg-gradient-to-br tw-text-white tw-font-medium disabled:tw-from-red-500 disabled:tw-via-red-600 disabled:tw-to-red-700 disabled:tw-cursor-not-allowed room-btn');
          button.setAttribute('data-bs-target', '#M'+String(i));
          button.disabled = occupancy_status[i-1];

          if (borg == 'b') {
            hostel_num = Number(idBoys.getElementsByClassName('form-select')[0].value)
          } else {
            hostel_num = Number(idGirls.getElementsByClassName('form-select')[0].value)
          }

          floor_num = Number(floor.getElementsByClassName('form-select')[0].value)
          button.setAttribute('onclick', 'setRoom("'+String(borg)+'" ,'+String(hostel_num)+', '+String(floor_num)+', '+String(i)+')');  
          button.textContent = i;
          
          buttonDiv.appendChild(button);
          buttonsContainer.appendChild(buttonDiv);
        }
      }

      async function getNumRooms(hostel_id, gender, floor_num) {
        try{
          // POST request using fetch() 
          const response = await fetch("/api/get_rooms_info", { 
              
              // Adding method type 
              method: "POST", 
                
              // Adding body or contents to send 
              body: JSON.stringify({"hostel_id": hostel_id, "gender": gender, "floor": floor_num}), 
                
              // Adding headers to the request 
              headers: { 
                  "Content-type": "application/json; charset=UTF-8"
              } 
          })

          if (!response.ok) {
              throw new Error(`API request failed with status ${response.status}`);
            }

            const jsonData = await response.json();
            return jsonData;
        } catch (error) {
          console.error('Error calling API:', error);
          throw error; // Re-throw the error for further handling
        }

        return json
      }

      function getOccupancyStatus(jsonData) {
        // Check if data is a valid JSON object
        if (typeof jsonData !== 'object' || jsonData === null) {
          throw new Error('Invalid JSON data provided');
        }

        // Handle array (list) of objects
        if (Array.isArray(jsonData)) {
          return jsonData.map(item => item.is_occupied);
        } else {
          // Handle single object (assuming 'is_occupied' is a property)
          return jsonData.is_occupied;
        }
      }
        girls.addEventListener("click", () => {
          borg = 'g';
          idBoys.style.display = "none";
          idGirls.style.display = "inherit";
          floor.style.display = "inherit";
          getBtn.style.display = 'inherit';

          // girls.style.backgroundColor = "orchid";
          // boys.style.backgroundColor = "white";
          girls.classList.add("active");
          boys.classList.remove("active");
        });

        boys.addEventListener("click", () => {
          borg = 'b';
          idGirls.style.display = "none";
          idBoys.style.display = "inherit";
          floor.style.display = "inherit";
          getBtn.style.display = 'inherit';

          // girls.style.backgroundColor = "white";
          // boys.style.backgroundColor = "mediumspringgreen";
          girls.classList.remove("active");
          boys.classList.add("active");
        });

        let rooms_info = null;
        let numCells = null;
        getBtn.addEventListener("click", () => {
          if (borg == 'b') {
            id = idBoys.getElementsByClassName('form-select')[0].value
          } else {
            id = idGirls.getElementsByClassName('form-select')[0].value
          }
          console.log(id);
        
          (async () => {
          try {
            rooms_info = await getNumRooms(id, borg, floor.getElementsByClassName('form-select')[0].value);
            console.log(rooms_info);
            generateButtons(getOccupancyStatus(rooms_info), 'rooms_grid');
          } catch (error) {
            console.error('Error fetching data:', error);
          }
          })();
        });
      </script>
    </div>

    <div class="page" id="page3" pageNo="3">
      <h2>Review Data</h2>
      <!-- Display entered data -->
      <div class="input-group">
        <label>Profile Photo:</label>
        <div id="photo-preview"></div>
      </div>

      <div class="input-group">
        <label for="reviewName">Name:</label>
        <span id="reviewName"></span>
      </div>
      <br>
      <div class="input-group">
        <label for="reviewAddress">Address:</label>
        <span id="reviewAddress"></span>
      </div>
      <br>
      <div class="input-group">
        <label for="reviewPhone">Mobile Number:</label>
        <span id="reviewPhone"></span>
      </div>
      <br>
      <div class="input-group">
        <label for="reviewEmail">Email:</label>
        <span id="reviewEmail"></span>
      </div>
      <br>
      <div class="input-group">
        <label for="reviewParent_name">Parent's Name:</label>
        <span id="reviewParent_name"></span>
      </div>
      <br>
      <div class="input-group">
        <label for="reviewParent_phone">Parent's Mobile Number:</label>
        <span id="reviewParent_phone"></span>
      </div>
      <br>
      <div class="input-group">
        <label for="reviewYear">Year:</label>
        <span id="reviewYear" ></span>
      </div>
      <br>
      <div class="input-group">
        <label for="reviewSemester">Semester:</label>
        <span id="reviewSemester"></span>
      </div>
      <br>
      <div class="input-group">
        <label for="reviewPr_number">PR Number:</label>
        <span id="reviewPr_number"></span>
      </div>
      <br>
      <div class="input-group">
        <label for="reviewDepartment">Department:</label>
        <span id="reviewDepartment"></span>
      </div>
      <div class="input-group">
        <label for="reviewGender">Gender:</label>
        <span id="reviewGender"></span>
      </div>
      <div class="input-group">
        <label for="reviewHostel_num">Hostel Num:</label>
        <span id="reviewHostel_num"></span>
      </div>
      <div class="input-group">
        <label for="reviewFloor_num">Floor Num:</label>
        <span id="reviewFloor_num"></span>
      </div>
      <div class="input-group">
        <label for="reviewRoom_num">Room Num:</label>
        <span id="reviewRoom_num"></span>
      </div>
      <br>
      <!-- Add other review fields here -->
      <button type='button' class="button tw-bg-gradient-to-r tw-from-blue-500 tw-via-blue-600 tw-to-blue-700 hover:tw-bg-gradient-to-br" onclick="prevPage()">Previous</button>
      <button class="button tw-bg-gradient-to-r tw-from-blue-500 tw-via-blue-600 tw-to-blue-700 hover:tw-bg-gradient-to-br" onclick="submitForm()">Submit</button>
    </div>
  </form>
</div>

<script src="assets/js/register.js"></script>
{% endblock %}